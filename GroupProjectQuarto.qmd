---
title: "GroupProjectQuarto"
author: "Claire Savage, Dani Wells, Abby Drongpa"
format: html
editor: visual
code-fold: true
self-contained: true
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

```{r setup}
library(tidyverse)
library(here)
library(broom)
CO2_emissions <- read_csv(here::here("co2_cons.csv"))
lex_data <- read_csv(here::here("lex.csv"))
```

## Data and Variable Descriptions

As the world experiences the increasing effects of climate change, it becomes important to look at how different aspects of climate change affect our lives. For this project we looked at the relationship between life expectancy at birth and total CO2 emissions. In order to do this, we used the “Life expectancy, at birth” and “Consumption CO2 emissions, million tonnes” variables from Gapminder in our analysis, with both of these data sets including information on 186 different countries. Total CO2 emissions was the explanatory variable, and was measured in million tonnes. It is total carbon dioxide emitted from each country per Capita. Life expectancy at birth was the response variable, and it was measured in years. It is the number of years an infant born in a given country in a given year would live if mortality rates stay the same throughout its life. We chose to study the relationship between these variables over the years 1920 to 2019 because these years were the most recent for which most countries had data available. We chose to omit the data post 2019 because we thought the COVID-19 pandemic might have altered the trends visualized in a way which is not representative of the data set as a whole.

We believe that increased levels of CO2 emission decrease life expectancy, which is line with a study conducted by the [National Library of Medicine](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8782287/#:~:text=Carbon%20emissions%20have%20a%20significantly,decreases%20life%20expectancy%20by%200.012%25.), “Carbon emissions have a significantly negative impact on life expectancy, suggesting that higher the carbon emissions lower the life expectancy.”

## Methods

```{r}
CO2_emissions_clean <- CO2_emissions %>%
  mutate(across(c(`2003`:`2006`,`2011`:`2013`), 
                ~str_replace(.x, 
                             pattern = "−", 
                             replace = "-")), 
         across(c(`2003`:`2006`,`2011`:`2013`), ~
                  as.numeric(.x))) %>% 
  select(country, `1920`:`2019`) %>% 
  pivot_longer(cols = `1920`:`2019`,
               names_to = "year",
               values_to = "emissions")
```

```{r}
lex_clean <- lex_data %>%
  select(country, `1920`:`2019`) %>%
  filter(if_all(c(`1920`:`2019`), ~ !is.na(.))) %>%
  pivot_longer(cols = `1920`:`2019`,
               names_to = "year",
               values_to = "life_exp")
```

```{r}
co2life_joined <- inner_join(CO2_emissions_clean, lex_clean)
```

We started by cleaning the data sets. For the CO2 emissions data set, the negative values in Panama were encoded dashes, so we replaced them with regular dashes in order to be able to convert those numbers to numeric values. The years in question, 1920-2019 were then selected and the table was pivoted to have each year and emission value combination with its own row. For the life expectancy data, we first selected the same years as the CO2 emisssions (1920-2019), and then took out any NA values. We then pivoted the table so that it was in a similar format to the CO2 emissions, with each year and life expectancy comibination in its own row. Once the individual data sets were properly formatted, we combined them so that for each country, there was a different row with the respective CO2 emissions and life expectancy values.

## Data Visualization

-   Present and discuss the visualizations of the relationship between the variables

-   Describe the statistical method used – linear regression

-   Present the estimated regression model (in notation)

-   Interpret the Linear Regression coefficients (in context)

-   Describe the fit of the regression model (both table and written format)

```{r}
#Seperating the data into 20 year chunks
years_1920_1939 <- as.character(seq(1920, 1939))
years_1940_1959 <- as.character(seq(1940, 1959))
years_1960_1979 <- as.character(seq(1960, 1979))
years_1980_1999 <- as.character(seq(1980, 1999))
years_2000_2019 <- as.character(seq(2000, 2019))

co2_life_twodecade <- co2life_joined|>
  mutate(
    year = as.factor(year)
  )|>
  mutate(
    twodecade = fct_collapse(year, 
                             `1920-1940` = years_1920_1939,
                             `1940-1959` = years_1940_1959,
                             `1960-1979` = years_1960_1979,
                             `1980-1999` = years_1980_1999,
                             `2000-2019` = years_2000_2019
    )

  ) 


#Averaging the data by country 
avg_co2_life <- co2_life_twodecade |>
  group_by(country, twodecade) |>
  summarise(
    avg_emissions = mean(emissions, na.rm = TRUE),
    avg_life_exp = mean(life_exp, na.rm = TRUE)
  )

```

```{r}
#The relationship between the two quantitative variables changing over time. Get creative!

co2_life_twodecade|>
  ggplot(
    aes( x = emissions, y = life_exp)
  ) +
  geom_point(size = 0.8, alpha = 0.5) +
  facet_wrap(~factor(twodecade))+
  theme_bw()+
  labs(
    title = "Scatterplot of CO2 emissions Vs. Life Expectancy", 
    subtitle = "Life Expectancy", 
    y = "", 
    x = "CO2 Emissions"
  )
```

```{r}
#The relationship between the two quantitative variables you are investigating.


```

**Hint: In investigating this relationship, you may want to first average over the years for each country (i.e., one observational row per country since our independence condition would be violated).**

## Linear Regression

Your final report should present the estimated regression model *and* provide an interpretation for each of the coefficients output.

```{r}
mod_co2life <- lm(life_exp ~ emissions, data = co2life_joined)
summary(mod_co2life)
```

## Model Fit

Make a nicely formatted table that presents the following:

-   The variance in the response values

-   The variance in the fitted values from your regression model

-   The variance in the residuals from your regression model

Discuss the proportion of the variability in the response values that was accounted for by your regression model. What does this suggest about the “quality” of your model?

```{r}
augment(mod_co2life) %>% 
  summarize(life_re = var(life_exp), 
            life_fitt = var(.fitted),
            life_resid = var(.resid)
            )
```

**Hint: The goal of regression is to account for as much variability in the *response* values as we can. Here, the variance in the *fitted values* represents the amount of variability in the response that was accounted for by the explanatory variable. The variance in the *residuals* represents the amount of variability in the responses that has *not* been accounted for.**
